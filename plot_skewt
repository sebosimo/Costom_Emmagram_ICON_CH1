import matplotlib.pyplot as plt
from matplotlib.ticker import FuncFormatter
import matplotlib.gridspec as gridspec
from metpy.plots import SkewT
from metpy.units import units
import metpy.calc as mpcalc
import xarray as xr
import os, datetime, glob

CACHE_DIR = "cache_data"

def format_pressure_as_km(x, pos):
    if x <= 0: return ""
    return f"{mpcalc.pressure_to_height_std(x * units.hPa).to('km').m:.1f}"

def main():
    files = glob.glob(os.path.join(CACHE_DIR, "*.nc"))
    if not files:
        print("No cached data! Run fetch_data.py first.")
        return
    
    latest_file = max(files, key=os.path.getctime)
    print(f"Plotting from cache: {latest_file}")
    ds = xr.open_dataset(latest_file)
    
    # Process data
    p = ds["P"].values * units.Pa
    t = (ds["T"].values * units.K).to(units.degC)
    u, v = ds["U"].values * units('m/s'), ds["V"].values * units('m/s')
    
    if ds.attrs["HUM_TYPE"] == "RELHUM":
        td = mpcalc.dewpoint_from_relative_humidity(t, ds["HUM"].values / 100.0)
    else:
        td = mpcalc.dewpoint_from_specific_humidity(p, t, ds["HUM"].values * units('kg/kg'))

    # Plot
    fig = plt.figure(figsize=(10, 10))
    skew = SkewT(fig, rotation=45)
    skew.plot(p, t, 'r', label='Temp')
    skew.plot(p, td, 'g', label='Dewpoint')
    skew.plot_barbs(p[::5], u[::5], v[::5])
    
    skew.ax.set_ylim(1050, 100)
    skew.ax.yaxis.set_major_formatter(FuncFormatter(format_pressure_as_km))
    
    plt.title(f"Sounding | {ds.attrs['ref_time']}")
    plt.savefig("latest_skewt.png")
    print("latest_skewt.png created.")

if __name__ == "__main__":
    main()
